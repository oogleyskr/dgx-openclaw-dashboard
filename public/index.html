<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGX OpenClaw Dashboard</title>
<style>
  /* ------------------------------------------------------------------ */
  /* Base / Reset                                                        */
  /* ------------------------------------------------------------------ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0d1117;
    --surface:   #161b22;
    --border:    #30363d;
    --text:      #e6edf3;
    --text-dim:  #8b949e;
    --green:     #3fb950;
    --red:       #f85149;
    --yellow:    #d29922;
    --blue:      #58a6ff;
    --cyan:      #39d353;
    --radius:    8px;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
  }

  /* ------------------------------------------------------------------ */
  /* Layout                                                              */
  /* ------------------------------------------------------------------ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header .meta { font-size: 13px; color: var(--text-dim); }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 16px;
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* ------------------------------------------------------------------ */
  /* Cards                                                               */
  /* ------------------------------------------------------------------ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--border);
    transition: background 0.3s;
  }
  .card.ok::before    { background: var(--green); }
  .card.error::before { background: var(--red); }
  .card.degraded::before { background: var(--yellow); }
  .card.loading::before {
    background: linear-gradient(90deg, var(--border) 25%, var(--blue) 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .badge {
    display: inline-block;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 12px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .badge.ok      { background: rgba(63,185,80,0.15); color: var(--green); }
  .badge.error   { background: rgba(248,81,73,0.15); color: var(--red); }
  .badge.degraded{ background: rgba(210,153,34,0.15); color: var(--yellow); }
  .badge.loading { background: rgba(88,166,255,0.15); color: var(--blue); }

  /* ------------------------------------------------------------------ */
  /* Metric rows                                                         */
  /* ------------------------------------------------------------------ */
  .metric {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid rgba(48,54,61,0.5);
    font-size: 14px;
  }
  .metric:last-child { border-bottom: none; }
  .metric .label { color: var(--text-dim); }
  .metric .value { font-weight: 500; font-variant-numeric: tabular-nums; }

  /* ------------------------------------------------------------------ */
  /* Progress bar (for GPU / memory)                                     */
  /* ------------------------------------------------------------------ */
  .bar-wrap {
    width: 100%;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    margin-top: 6px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
  }
  .bar-fill.green  { background: var(--green); }
  .bar-fill.yellow { background: var(--yellow); }
  .bar-fill.red    { background: var(--red); }

  /* ------------------------------------------------------------------ */
  /* Session list                                                        */
  /* ------------------------------------------------------------------ */
  .session-list {
    list-style: none;
    font-size: 12px;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    color: var(--text-dim);
    margin-top: 8px;
  }
  .session-list li {
    padding: 2px 0;
    display: flex;
    justify-content: space-between;
  }

  /* ------------------------------------------------------------------ */
  /* Logs                                                                */
  /* ------------------------------------------------------------------ */
  .log-list {
    list-style: none;
    font-size: 12px;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    color: var(--text-dim);
    max-height: 160px;
    overflow-y: auto;
  }
  .log-list li {
    padding: 3px 0;
    border-bottom: 1px solid rgba(48,54,61,0.3);
    word-break: break-all;
  }

  /* ------------------------------------------------------------------ */
  /* Error message                                                       */
  /* ------------------------------------------------------------------ */
  .error-msg {
    color: var(--red);
    font-size: 13px;
    padding: 8px 0;
  }

  /* ------------------------------------------------------------------ */
  /* Footer                                                              */
  /* ------------------------------------------------------------------ */
  .footer {
    text-align: center;
    padding: 16px;
    font-size: 12px;
    color: var(--text-dim);
  }

  /* ------------------------------------------------------------------ */
  /* Responsive                                                          */
  /* ------------------------------------------------------------------ */
  @media (max-width: 600px) {
    .grid { padding: 12px; gap: 12px; grid-template-columns: 1fr; }
    .header { flex-direction: column; gap: 4px; text-align: center; }
  }
</style>
</head>
<body>

<!-- ================================================================== -->
<!-- Header                                                              -->
<!-- ================================================================== -->
<header class="header">
  <h1>DGX OpenClaw Dashboard</h1>
  <div class="meta">
    <span id="overall-badge" class="badge loading">connecting</span>
    &nbsp; Last updated: <span id="last-update">--</span>
    &nbsp; Refresh: <span id="collect-time">--</span>
  </div>
</header>

<!-- ================================================================== -->
<!-- Cards grid                                                          -->
<!-- ================================================================== -->
<main class="grid">

  <!-- GPU Stats -->
  <section class="card loading" id="card-gpu">
    <div class="card-title">
      GPU Stats
      <span class="badge loading" id="gpu-badge">--</span>
    </div>
    <div id="gpu-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- Model Provider -->
  <section class="card loading" id="card-provider">
    <div class="card-title">
      Model Server (llama.cpp)
      <span class="badge loading" id="provider-badge">--</span>
    </div>
    <div id="provider-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- OpenClaw Gateway -->
  <section class="card loading" id="card-gateway">
    <div class="card-title">
      OpenClaw Gateway
      <span class="badge loading" id="gateway-badge">--</span>
    </div>
    <div id="gateway-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- SSH Tunnel -->
  <section class="card loading" id="card-tunnel">
    <div class="card-title">
      SSH Tunnel
      <span class="badge loading" id="tunnel-badge">--</span>
    </div>
    <div id="tunnel-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- Recent Activity / Logs -->
  <section class="card" id="card-activity" style="grid-column: 1 / -1;">
    <div class="card-title">Recent Activity</div>
    <ul class="log-list" id="activity-log">
      <li>Waiting for first poll...</li>
    </ul>
  </section>

</main>

<footer class="footer">
  DGX Spark (NVIDIA GB10) &middot; 128 GB unified LPDDR5x &middot; ARM64 &middot; Ubuntu 24.04
  &middot; Data via OpenClaw Gateway RPC
</footer>

<!-- ================================================================== -->
<!-- Dashboard logic                                                     -->
<!-- ================================================================== -->
<script>
(function() {
  'use strict';

  var POLL_INTERVAL = 10000;
  var MAX_LOG_ENTRIES = 50;

  var $overall    = document.getElementById('overall-badge');
  var $lastUpdate = document.getElementById('last-update');
  var $collectTime = document.getElementById('collect-time');

  var cards = {
    gpu:      { card: 'card-gpu',      badge: 'gpu-badge',      body: 'gpu-body' },
    provider: { card: 'card-provider', badge: 'provider-badge', body: 'provider-body' },
    gateway:  { card: 'card-gateway',  badge: 'gateway-badge',  body: 'gateway-body' },
    tunnel:   { card: 'card-tunnel',   badge: 'tunnel-badge',   body: 'tunnel-body' },
  };

  var activityLog = document.getElementById('activity-log');
  var logEntries = [];

  // ----------------------------------------------------------------
  // Helpers
  // ----------------------------------------------------------------

  function setStatus(cardKey, status) {
    var c = cards[cardKey];
    var el = document.getElementById(c.card);
    var badge = document.getElementById(c.badge);
    el.className = 'card ' + status;
    badge.className = 'badge ' + status;
    badge.textContent = status.toUpperCase();
  }

  function metric(label, value) {
    return '<div class="metric"><span class="label">' + esc(label) + '</span><span class="value">' + esc(String(value)) + '</span></div>';
  }

  function progressBar(pct) {
    var cls = pct < 70 ? 'green' : pct < 90 ? 'yellow' : 'red';
    return '<div class="bar-wrap"><div class="bar-fill ' + cls + '" style="width:' + Math.min(pct, 100) + '%"></div></div>';
  }

  function esc(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function addLog(msg) {
    var ts = new Date().toLocaleTimeString();
    logEntries.unshift('[' + ts + '] ' + msg);
    if (logEntries.length > MAX_LOG_ENTRIES) logEntries.pop();
    activityLog.innerHTML = logEntries.map(function(e){ return '<li>' + esc(e) + '</li>'; }).join('');
  }

  function formatAge(seconds) {
    if (seconds < 60) return seconds + 's ago';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
  }

  // ----------------------------------------------------------------
  // Renderers
  // ----------------------------------------------------------------

  function renderGpu(data) {
    var body = document.getElementById(cards.gpu.body);
    setStatus('gpu', data.status);

    if (data.status === 'error') {
      body.innerHTML = '<div class="error-msg">' + esc(data.error || 'Unknown error') + '</div>';
      addLog('GPU: error - ' + (data.error || ''));
      return;
    }

    var html =
      metric('GPU', data.gpu_name || '--') +
      metric('Host', data.host || '--') +
      metric('Utilization', (data.utilization_pct || 0) + '%') +
      progressBar(data.utilization_pct || 0);

    if (data.memory_used_mb != null) {
      html +=
        metric('Memory', data.memory_used_mb + ' / ' + data.memory_total_mb + ' MB (' + data.memory_pct + '%)') +
        progressBar(data.memory_pct);
    } else if (data.memory_note) {
      html += metric('Memory', data.memory_note);
    }

    html += metric('Temperature', (data.temperature_c || '--') + ' C');

    if (data.power_w != null) {
      var powerStr = data.power_w + ' W';
      if (data.power_limit_w) powerStr += ' / ' + data.power_limit_w + ' W';
      html += metric('Power', powerStr);
    }

    body.innerHTML = html;
    addLog('GPU: ' + (data.utilization_pct || 0) + '% util, ' + (data.temperature_c || '--') + 'C');
  }

  function renderProvider(data) {
    var body = document.getElementById(cards.provider.body);
    setStatus('provider', data.status);

    if (data.status === 'error') {
      body.innerHTML = '<div class="error-msg">' + esc(data.error || 'Unreachable') + '</div>';
      if (data.consecutive_failures) {
        body.innerHTML += metric('Consecutive Failures', data.consecutive_failures);
      }
      addLog('Provider: DOWN - ' + (data.error || ''));
      return;
    }

    var html =
      metric('Provider', data.provider || '--') +
      metric('Server', data.server || 'unknown') +
      metric('Endpoint', data.base_url || '--') +
      metric('Healthy', data.healthy ? 'Yes' : 'No') +
      metric('Latency', (data.latency_ms || '--') + ' ms');

    if (data.consecutive_failures > 0) {
      html += metric('Recent Failures', data.consecutive_failures);
    }

    body.innerHTML = html;
    addLog('Provider: ' + data.provider + ' healthy, ' + (data.latency_ms || '--') + 'ms');
  }

  function renderGateway(data) {
    var body = document.getElementById(cards.gateway.body);
    setStatus('gateway', data.status);

    if (data.status === 'error') {
      body.innerHTML = '<div class="error-msg">' + esc(data.error || 'Gateway unreachable') + '</div>';
      addLog('Gateway: UNREACHABLE');
      return;
    }

    var html =
      metric('Status', data.gateway_ok ? 'Running' : 'Down') +
      metric('Health Latency', (data.latency_ms || '--') + ' ms');

    // Discord info
    if (data.discord) {
      var d = data.discord;
      html +=
        metric('Discord Bot', d.bot_name || '--') +
        metric('Discord Status', d.ok ? 'Connected' : 'Error') +
        metric('Discord Latency', (d.latency_ms || '--') + ' ms');
    }

    // Sessions
    if (data.session_count != null) {
      html += metric('Active Sessions', data.session_count);
    }

    if (data.sessions && data.sessions.length) {
      html += '<ul class="session-list">';
      data.sessions.forEach(function(s) {
        html += '<li><span>' + esc(s.key) + '</span><span>' + formatAge(s.age_seconds) + '</span></li>';
      });
      html += '</ul>';
    }

    body.innerHTML = html;
    var discordMsg = data.discord ? (', Discord: ' + (data.discord.ok ? data.discord.bot_name : 'ERROR')) : '';
    addLog('Gateway: ok' + discordMsg + ', ' + (data.session_count || 0) + ' sessions');
  }

  function renderTunnel(data) {
    var body = document.getElementById(cards.tunnel.body);
    setStatus('tunnel', data.status);

    if (data.status === 'error' && data.error) {
      body.innerHTML = '<div class="error-msg">' + esc(data.error) + '</div>';
      addLog('Tunnel: DOWN - ' + data.error);
      return;
    }

    var html =
      metric('Host', (data.host || '--') + ':' + (data.port || '--')) +
      metric('Reachable', data.reachable ? 'Yes' : 'No') +
      metric('Latency', (data.latency_ms || '--') + ' ms');

    if (data.service_name) {
      html +=
        metric('Service', data.service_name) +
        metric('Service Active', data.service_active ? 'Yes' : 'No');
    }

    if (data.status === 'error') {
      html += '<div class="error-msg">Tunnel unreachable</div>';
      addLog('Tunnel: DOWN');
    } else if (data.status === 'degraded') {
      html += '<div class="error-msg">Service active but port unreachable</div>';
      addLog('Tunnel: degraded');
    } else {
      addLog('Tunnel: ok, ' + (data.latency_ms || '--') + 'ms');
    }

    body.innerHTML = html;
  }

  // ----------------------------------------------------------------
  // Polling
  // ----------------------------------------------------------------

  function poll() {
    fetch('/api/overview')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        $overall.className = 'badge ' + data.overall;
        $overall.textContent = data.overall.toUpperCase();
        $lastUpdate.textContent = data.timestamp || new Date().toISOString();
        $collectTime.textContent = (data.collect_time_ms || '--') + ' ms';

        if (data.gpu)      renderGpu(data.gpu);
        if (data.provider) renderProvider(data.provider);
        if (data.gateway)  renderGateway(data.gateway);
        if (data.tunnel)   renderTunnel(data.tunnel);
      })
      .catch(function(err) {
        $overall.className = 'badge error';
        $overall.textContent = 'OFFLINE';
        addLog('Fetch error: ' + err);
      });
  }

  poll();
  setInterval(poll, POLL_INTERVAL);

})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGX OpenClaw Dashboard</title>
<style>
  /* ------------------------------------------------------------------ */
  /* Base / Reset                                                        */
  /* ------------------------------------------------------------------ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0d1117;
    --surface:   #161b22;
    --border:    #30363d;
    --text:      #e6edf3;
    --text-dim:  #8b949e;
    --green:     #3fb950;
    --red:       #f85149;
    --yellow:    #d29922;
    --blue:      #58a6ff;
    --cyan:      #39d353;
    --purple:    #bc8cff;
    --radius:    8px;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
  }

  /* ------------------------------------------------------------------ */
  /* Layout                                                              */
  /* ------------------------------------------------------------------ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header .meta { font-size: 13px; color: var(--text-dim); }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 16px;
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* ------------------------------------------------------------------ */
  /* Cards                                                               */
  /* ------------------------------------------------------------------ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--border);
    transition: background 0.3s;
  }
  .card.ok::before    { background: var(--green); }
  .card.error::before { background: var(--red); }
  .card.degraded::before { background: var(--yellow); }
  .card.loading::before {
    background: linear-gradient(90deg, var(--border) 25%, var(--blue) 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .badge {
    display: inline-block;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 12px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .badge.ok      { background: rgba(63,185,80,0.15); color: var(--green); }
  .badge.error   { background: rgba(248,81,73,0.15); color: var(--red); }
  .badge.degraded{ background: rgba(210,153,34,0.15); color: var(--yellow); }
  .badge.loading { background: rgba(88,166,255,0.15); color: var(--blue); }

  /* ------------------------------------------------------------------ */
  /* Metric rows                                                         */
  /* ------------------------------------------------------------------ */
  .metric {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid rgba(48,54,61,0.5);
    font-size: 14px;
  }
  .metric:last-child { border-bottom: none; }
  .metric .label { color: var(--text-dim); }
  .metric .value { font-weight: 500; font-variant-numeric: tabular-nums; }

  /* ------------------------------------------------------------------ */
  /* Progress bar (for GPU / memory utilization)                         */
  /* ------------------------------------------------------------------ */
  .bar-wrap {
    width: 100%;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    margin-top: 6px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
  }
  .bar-fill.green  { background: var(--green); }
  .bar-fill.yellow { background: var(--yellow); }
  .bar-fill.red    { background: var(--red); }

  /* ------------------------------------------------------------------ */
  /* Multimodal service grid (compact table within a card)               */
  /* ------------------------------------------------------------------ */
  .svc-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 8px;
  }
  .svc-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: rgba(48,54,61,0.3);
    border-radius: 6px;
    font-size: 13px;
  }
  .svc-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .svc-dot.ok      { background: var(--green); }
  .svc-dot.error   { background: var(--red); }
  .svc-dot.loading { background: var(--yellow); }
  .svc-name {
    font-weight: 600;
    color: var(--text);
    min-width: 72px;
  }
  .svc-model {
    color: var(--text-dim);
    font-size: 11px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .svc-port {
    color: var(--text-dim);
    font-size: 11px;
    margin-left: auto;
    flex-shrink: 0;
  }

  /* ------------------------------------------------------------------ */
  /* Session list                                                        */
  /* ------------------------------------------------------------------ */
  .session-list {
    list-style: none;
    font-size: 12px;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    color: var(--text-dim);
    margin-top: 8px;
  }
  .session-list li {
    padding: 2px 0;
    display: flex;
    justify-content: space-between;
  }

  /* ------------------------------------------------------------------ */
  /* Logs (activity feed)                                                */
  /* ------------------------------------------------------------------ */
  .log-list {
    list-style: none;
    font-size: 12px;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    color: var(--text-dim);
    max-height: 160px;
    overflow-y: auto;
  }
  .log-list li {
    padding: 3px 0;
    border-bottom: 1px solid rgba(48,54,61,0.3);
    word-break: break-all;
  }

  /* ------------------------------------------------------------------ */
  /* Form controls (heartbeat config)                                    */
  /* ------------------------------------------------------------------ */
  .control-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(48,54,61,0.5);
    font-size: 14px;
  }
  .control-row:last-child { border-bottom: none; }
  .control-row .label { color: var(--text-dim); }

  /* Toggle switch */
  .toggle {
    position: relative;
    width: 44px;
    height: 24px;
    cursor: pointer;
  }
  .toggle input { display: none; }
  .toggle .slider {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 12px;
    transition: background 0.2s;
  }
  .toggle .slider::before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    left: 3px;
    top: 3px;
    background: var(--text);
    border-radius: 50%;
    transition: transform 0.2s;
  }
  .toggle input:checked + .slider { background: var(--green); }
  .toggle input:checked + .slider::before { transform: translateX(20px); }

  /* Select dropdown */
  .hb-select {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 13px;
    font-family: inherit;
    max-width: 220px;
    cursor: pointer;
  }
  .hb-select:focus { outline: 1px solid var(--blue); }

  /* Save button */
  .hb-save {
    background: var(--green);
    color: #000;
    border: none;
    border-radius: 6px;
    padding: 6px 16px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .hb-save:hover { opacity: 0.85; }
  .hb-save:disabled { opacity: 0.4; cursor: not-allowed; }
  .hb-save-msg {
    font-size: 12px;
    margin-left: 8px;
  }
  .hb-save-msg.success { color: var(--green); }
  .hb-save-msg.error { color: var(--red); }

  /* ------------------------------------------------------------------ */
  /* Error message                                                       */
  /* ------------------------------------------------------------------ */
  .error-msg {
    color: var(--red);
    font-size: 13px;
    padding: 8px 0;
  }

  /* ------------------------------------------------------------------ */
  /* Footer                                                              */
  /* ------------------------------------------------------------------ */
  .footer {
    text-align: center;
    padding: 16px;
    font-size: 12px;
    color: var(--text-dim);
  }

  /* ------------------------------------------------------------------ */
  /* Responsive                                                          */
  /* ------------------------------------------------------------------ */
  @media (max-width: 600px) {
    .grid { padding: 12px; gap: 12px; grid-template-columns: 1fr; }
    .header { flex-direction: column; gap: 4px; text-align: center; }
    .svc-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- ================================================================== -->
<!-- Header — overall status badge, last update time, poll duration      -->
<!-- ================================================================== -->
<header class="header">
  <h1>DGX OpenClaw Dashboard</h1>
  <div class="meta">
    <span id="overall-badge" class="badge loading">connecting</span>
    &nbsp; Last updated: <span id="last-update">--</span>
    &nbsp; Refresh: <span id="collect-time">--</span>
  </div>
</header>

<!-- ================================================================== -->
<!-- Cards grid — 6 monitoring cards + activity log                      -->
<!-- ================================================================== -->
<main class="grid">

  <!-- Card 1: DGX Spark GPU (remote, via gateway RPC) -->
  <section class="card loading" id="card-gpu">
    <div class="card-title">
      DGX Spark GPU
      <span class="badge loading" id="gpu-badge">--</span>
    </div>
    <div id="gpu-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- Card 2: Local RTX 3090 GPU (local nvidia-smi) -->
  <section class="card loading" id="card-local-gpu">
    <div class="card-title">
      RTX 3090 GPU
      <span class="badge loading" id="local-gpu-badge">--</span>
    </div>
    <div id="local-gpu-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- Card 3: Model Provider / llama.cpp (via gateway RPC) -->
  <section class="card loading" id="card-provider">
    <div class="card-title">
      Model Server (llama.cpp)
      <span class="badge loading" id="provider-badge">--</span>
    </div>
    <div id="provider-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- Card 4: OpenClaw Gateway + Discord (via gateway RPC) -->
  <section class="card loading" id="card-gateway">
    <div class="card-title">
      OpenClaw Gateway
      <span class="badge loading" id="gateway-badge">--</span>
    </div>
    <div id="gateway-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- Card 5: SSH Tunnel (via gateway RPC) -->
  <section class="card loading" id="card-tunnel">
    <div class="card-title">
      SSH Tunnel
      <span class="badge loading" id="tunnel-badge">--</span>
    </div>
    <div id="tunnel-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- Card 6: Multimodal Services (local HTTP health checks) — full width -->
  <section class="card loading" id="card-multimodal" style="grid-column: 1 / -1;">
    <div class="card-title">
      Multimodal Services (RTX 3090)
      <span class="badge loading" id="multimodal-badge">--</span>
    </div>
    <div id="multimodal-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- Card 7: Heartbeat LLM Server (config + status) — full width -->
  <section class="card loading" id="card-heartbeat" style="grid-column: 1 / -1;">
    <div class="card-title">
      Heartbeat LLM Server
      <span class="badge loading" id="heartbeat-badge">--</span>
    </div>
    <div id="heartbeat-body">
      <div class="metric"><span class="label">Loading...</span></div>
    </div>
  </section>

  <!-- Activity log — recent status changes (full width) -->
  <section class="card" id="card-activity" style="grid-column: 1 / -1;">
    <div class="card-title">Recent Activity</div>
    <ul class="log-list" id="activity-log">
      <li>Waiting for first poll...</li>
    </ul>
  </section>

</main>

<footer class="footer">
  DGX Spark (NVIDIA GB10) &middot; 128 GB unified LPDDR5x &middot; ARM64
  &nbsp;|&nbsp;
  RTX 3090 (24 GB GDDR6X) &middot; Multimodal AI Services
  &nbsp;|&nbsp;
  Data via OpenClaw Gateway RPC + Local Probes
</footer>

<!-- ================================================================== -->
<!-- Dashboard logic — polling, rendering, status computation            -->
<!-- ================================================================== -->
<script>
(function() {
  'use strict';

  // -- Configuration --
  var POLL_INTERVAL = 10000;   // Poll every 10 seconds
  var MAX_LOG_ENTRIES = 50;    // Max activity log entries to keep

  // -- DOM references --
  var $overall    = document.getElementById('overall-badge');
  var $lastUpdate = document.getElementById('last-update');
  var $collectTime = document.getElementById('collect-time');

  // Card element IDs for status/badge/body updates
  var cards = {
    gpu:        { card: 'card-gpu',        badge: 'gpu-badge',        body: 'gpu-body' },
    local_gpu:  { card: 'card-local-gpu',  badge: 'local-gpu-badge',  body: 'local-gpu-body' },
    provider:   { card: 'card-provider',   badge: 'provider-badge',   body: 'provider-body' },
    gateway:    { card: 'card-gateway',    badge: 'gateway-badge',    body: 'gateway-body' },
    tunnel:     { card: 'card-tunnel',     badge: 'tunnel-badge',     body: 'tunnel-body' },
    multimodal: { card: 'card-multimodal', badge: 'multimodal-badge', body: 'multimodal-body' },
    heartbeat:  { card: 'card-heartbeat',  badge: 'heartbeat-badge',  body: 'heartbeat-body' },
  };

  var activityLog = document.getElementById('activity-log');
  var logEntries = [];

  // ----------------------------------------------------------------
  // Helpers — shared utility functions for rendering
  // ----------------------------------------------------------------

  /**
   * Set a card's visual status (ok/error/degraded/loading).
   * Updates both the card border color and the badge text.
   */
  function setStatus(cardKey, status) {
    var c = cards[cardKey];
    var el = document.getElementById(c.card);
    var badge = document.getElementById(c.badge);
    el.className = 'card ' + status;
    badge.className = 'badge ' + status;
    badge.textContent = status.toUpperCase();
  }

  /**
   * Generate a metric row (label on left, value on right).
   * All values are HTML-escaped via esc().
   */
  function metric(label, value) {
    return '<div class="metric"><span class="label">' + esc(label) + '</span><span class="value">' + esc(String(value)) + '</span></div>';
  }

  /**
   * Generate a progress bar with color based on percentage.
   * Green < 70%, Yellow < 90%, Red >= 90%.
   */
  function progressBar(pct) {
    var cls = pct < 70 ? 'green' : pct < 90 ? 'yellow' : 'red';
    return '<div class="bar-wrap"><div class="bar-fill ' + cls + '" style="width:' + Math.min(pct, 100) + '%"></div></div>';
  }

  /**
   * HTML-escape a string to prevent XSS.
   * Uses DOM textContent → innerHTML trick for safe escaping.
   */
  function esc(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  /**
   * Add a timestamped entry to the activity log.
   * Keeps only the most recent MAX_LOG_ENTRIES entries.
   */
  function addLog(msg) {
    var ts = new Date().toLocaleTimeString();
    logEntries.unshift('[' + ts + '] ' + msg);
    if (logEntries.length > MAX_LOG_ENTRIES) logEntries.pop();
    activityLog.innerHTML = logEntries.map(function(e){ return '<li>' + esc(e) + '</li>'; }).join('');
  }

  /**
   * Format a duration in seconds to a human-readable string.
   * e.g. 45 → "45s ago", 120 → "2m ago", 7200 → "2h ago"
   */
  function formatAge(seconds) {
    if (seconds < 60) return seconds + 's ago';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
  }

  // ----------------------------------------------------------------
  // Renderers — one function per card, transforms JSON → HTML
  // ----------------------------------------------------------------

  /**
   * Render the DGX Spark GPU card (remote, via gateway RPC).
   * Shows utilization, memory, temperature, and power.
   */
  function renderGpu(data) {
    var body = document.getElementById(cards.gpu.body);
    setStatus('gpu', data.status);

    if (data.status === 'error') {
      body.innerHTML = '<div class="error-msg">' + esc(data.error || 'Unknown error') + '</div>';
      addLog('DGX GPU: error - ' + (data.error || ''));
      return;
    }

    var html =
      metric('GPU', data.gpu_name || '--') +
      metric('Host', data.host || '--') +
      metric('Utilization', (data.utilization_pct || 0) + '%') +
      progressBar(data.utilization_pct || 0);

    if (data.memory_used_mb != null) {
      html +=
        metric('Memory', data.memory_used_mb + ' / ' + data.memory_total_mb + ' MB (' + data.memory_pct + '%)') +
        progressBar(data.memory_pct);
    } else if (data.memory_note) {
      html += metric('Memory', data.memory_note);
    }

    html += metric('Temperature', (data.temperature_c || '--') + ' C');

    if (data.power_w != null) {
      var powerStr = data.power_w + ' W';
      if (data.power_limit_w) powerStr += ' / ' + data.power_limit_w + ' W';
      html += metric('Power', powerStr);
    }

    body.innerHTML = html;
    addLog('DGX GPU: ' + (data.utilization_pct || 0) + '% util, ' + (data.temperature_c || '--') + 'C');
  }

  /**
   * Render the local RTX 3090 GPU card (local nvidia-smi).
   * Shows VRAM usage (critical for multimodal services), utilization,
   * temperature, and power draw.
   */
  function renderLocalGpu(data) {
    var body = document.getElementById(cards.local_gpu.body);
    setStatus('local_gpu', data.status);

    if (data.status === 'error') {
      body.innerHTML = '<div class="error-msg">' + esc(data.error || 'nvidia-smi unavailable') + '</div>';
      addLog('RTX 3090: error - ' + (data.error || ''));
      return;
    }

    var html =
      metric('GPU', data.gpu_name || '--') +
      metric('Utilization', (data.utilization_pct || 0) + '%') +
      progressBar(data.utilization_pct || 0);

    if (data.memory_used_mb != null) {
      var memStr = data.memory_used_mb + ' / ' + data.memory_total_mb + ' MB (' + data.memory_pct + '%)';
      html +=
        metric('VRAM', memStr) +
        progressBar(data.memory_pct);
      if (data.memory_free_mb != null) {
        html += metric('VRAM Free', data.memory_free_mb + ' MB');
      }
    }

    html += metric('Temperature', (data.temperature_c || '--') + ' C');

    if (data.power_w != null) {
      var powerStr = data.power_w + ' W';
      if (data.power_limit_w) powerStr += ' / ' + data.power_limit_w + ' W';
      html += metric('Power', powerStr);
    }

    body.innerHTML = html;
    addLog('RTX 3090: ' + (data.utilization_pct || 0) + '% util, ' +
           (data.memory_used_mb || '--') + '/' + (data.memory_total_mb || '--') + ' MB VRAM, ' +
           (data.temperature_c || '--') + 'C');
  }

  /**
   * Render the model provider card (llama.cpp on DGX).
   * Shows health status, endpoint, latency, and failure count.
   */
  function renderProvider(data) {
    var body = document.getElementById(cards.provider.body);
    setStatus('provider', data.status);

    if (data.status === 'error') {
      body.innerHTML = '<div class="error-msg">' + esc(data.error || 'Unreachable') + '</div>';
      if (data.consecutive_failures) {
        body.innerHTML += metric('Consecutive Failures', data.consecutive_failures);
      }
      addLog('Provider: DOWN - ' + (data.error || ''));
      return;
    }

    var html =
      metric('Provider', data.provider || '--') +
      metric('Server', data.server || 'unknown') +
      metric('Endpoint', data.base_url || '--') +
      metric('Healthy', data.healthy ? 'Yes' : 'No') +
      metric('Latency', (data.latency_ms || '--') + ' ms');

    if (data.consecutive_failures > 0) {
      html += metric('Recent Failures', data.consecutive_failures);
    }

    body.innerHTML = html;
    addLog('Provider: ' + data.provider + ' healthy, ' + (data.latency_ms || '--') + 'ms');
  }

  /**
   * Render the OpenClaw gateway card.
   * Shows gateway health, Discord bot status, and recent sessions.
   */
  function renderGateway(data) {
    var body = document.getElementById(cards.gateway.body);
    setStatus('gateway', data.status);

    if (data.status === 'error') {
      body.innerHTML = '<div class="error-msg">' + esc(data.error || 'Gateway unreachable') + '</div>';
      addLog('Gateway: UNREACHABLE');
      return;
    }

    var html =
      metric('Status', data.gateway_ok ? 'Running' : 'Down') +
      metric('Health Latency', (data.latency_ms || '--') + ' ms');

    // Discord bot connection info
    if (data.discord) {
      var d = data.discord;
      html +=
        metric('Discord Bot', d.bot_name || '--') +
        metric('Discord Status', d.ok ? 'Connected' : 'Error') +
        metric('Discord Latency', (d.latency_ms || '--') + ' ms');
    }

    // Active agent sessions
    if (data.session_count != null) {
      html += metric('Active Sessions', data.session_count);
    }

    if (data.sessions && data.sessions.length) {
      html += '<ul class="session-list">';
      data.sessions.forEach(function(s) {
        html += '<li><span>' + esc(s.key) + '</span><span>' + formatAge(s.age_seconds) + '</span></li>';
      });
      html += '</ul>';
    }

    body.innerHTML = html;
    var discordMsg = data.discord ? (', Discord: ' + (data.discord.ok ? data.discord.bot_name : 'ERROR')) : '';
    addLog('Gateway: ok' + discordMsg + ', ' + (data.session_count || 0) + ' sessions');
  }

  /**
   * Render the SSH tunnel card.
   * Shows host/port, reachability, latency, and systemd service status.
   */
  function renderTunnel(data) {
    var body = document.getElementById(cards.tunnel.body);
    setStatus('tunnel', data.status);

    if (data.status === 'error' && data.error) {
      body.innerHTML = '<div class="error-msg">' + esc(data.error) + '</div>';
      addLog('Tunnel: DOWN - ' + data.error);
      return;
    }

    var html =
      metric('Host', (data.host || '--') + ':' + (data.port || '--')) +
      metric('Reachable', data.reachable ? 'Yes' : 'No') +
      metric('Latency', (data.latency_ms || '--') + ' ms');

    if (data.service_name) {
      html +=
        metric('Service', data.service_name) +
        metric('Service Active', data.service_active ? 'Yes' : 'No');
    }

    if (data.status === 'error') {
      html += '<div class="error-msg">Tunnel unreachable</div>';
      addLog('Tunnel: DOWN');
    } else if (data.status === 'degraded') {
      html += '<div class="error-msg">Service active but port unreachable</div>';
      addLog('Tunnel: degraded');
    } else {
      addLog('Tunnel: ok, ' + (data.latency_ms || '--') + 'ms');
    }

    body.innerHTML = html;
  }

  /**
   * Render the multimodal services card.
   * Shows a compact 2-column grid of all 6 services with status dots,
   * service names, ports, and loaded model names.
   */
  function renderMultimodal(data) {
    var body = document.getElementById(cards.multimodal.body);
    setStatus('multimodal', data.status);

    // Set badge to show count like "6/6 UP"
    var badge = document.getElementById(cards.multimodal.badge);
    badge.textContent = (data.services_up || 0) + '/' + (data.services_total || 0) + ' UP';

    if (data.status === 'error' && !data.services) {
      body.innerHTML = '<div class="error-msg">All services down</div>';
      addLog('Multimodal: ALL DOWN');
      return;
    }

    // Summary row
    var html = metric('Services Online', (data.services_up || 0) + ' / ' + (data.services_total || 0));

    // Service grid — 2 columns of service items with status dots
    if (data.services) {
      html += '<div class="svc-grid">';

      // Define display order and friendly labels
      var order = [
        { key: 'stt',        label: 'STT' },
        { key: 'vision',     label: 'Vision' },
        { key: 'tts',        label: 'TTS' },
        { key: 'imagegen',   label: 'ImageGen' },
      ];

      order.forEach(function(item) {
        var svc = data.services[item.key];
        if (!svc) return;
        var dotCls = svc.status === 'ok' ? 'ok' : svc.status === 'loading' ? 'loading' : 'error';
        var modelText = svc.model ? svc.model.split('/').pop() : '--';
        html +=
          '<div class="svc-item">' +
            '<span class="svc-dot ' + dotCls + '"></span>' +
            '<span class="svc-name">' + esc(item.label) + '</span>' +
            '<span class="svc-model" title="' + esc(svc.model || '') + '">' + esc(modelText) + '</span>' +
            '<span class="svc-port">:' + svc.port + '</span>' +
          '</div>';
      });

      html += '</div>';
    }

    body.innerHTML = html;
    addLog('Multimodal: ' + (data.services_up || 0) + '/' + (data.services_total || 0) + ' services up');
  }

  /**
   * Render the heartbeat LLM server card.
   * Shows server status, model info, systemd state, and config controls
   * (enable/disable toggle, model picker, save button).
   */
  function renderHeartbeat(data) {
    var body = document.getElementById(cards.heartbeat.body);
    setStatus('heartbeat', data.status);

    if (data.status === 'error' && !data.config) {
      body.innerHTML = '<div class="error-msg">Heartbeat server offline</div>';
      addLog('Heartbeat: OFFLINE');
      return;
    }

    var cfg = data.config || {};
    var html = '';

    // Server status section
    html += metric('Server', data.server_healthy ? 'Healthy' : 'Down');
    html += metric('Port', data.port || '--');
    if (data.model) html += metric('Model', data.model);
    if (data.model_params) html += metric('Parameters', (data.model_params / 1e9).toFixed(1) + 'B');
    if (data.context_train) html += metric('Max Context', (data.context_train / 1024).toFixed(0) + 'K tokens');
    if (data.service_status) html += metric('Systemd', data.service_status);

    // Config controls
    html += '<div style="margin-top:16px; padding-top:12px; border-top:1px solid var(--border);">';
    html += '<div style="font-size:13px; color:var(--text-dim); margin-bottom:8px; font-weight:600;">HEARTBEAT CONFIG</div>';

    // Enable/disable toggle
    var checked = cfg.enabled ? 'checked' : '';
    html += '<div class="control-row">' +
      '<span class="label">Enabled</span>' +
      '<label class="toggle"><input type="checkbox" id="hb-enabled" ' + checked + '><span class="slider"></span></label>' +
      '</div>';

    // Model picker
    html += '<div class="control-row">' +
      '<span class="label">Model</span>' +
      '<select class="hb-select" id="hb-model">';
    var models = cfg.available_models || [];
    models.forEach(function(m) {
      var sel = m.ref === cfg.model ? ' selected' : '';
      html += '<option value="' + esc(m.ref) + '"' + sel + '>' + esc(m.name) + '</option>';
    });
    if (!models.length) html += '<option value="">No models available</option>';
    html += '</select></div>';

    // Interval
    html += '<div class="control-row">' +
      '<span class="label">Interval</span>' +
      '<select class="hb-select" id="hb-every">';
    var intervals = ['5m','10m','15m','30m','1h','2h'];
    intervals.forEach(function(v) {
      var sel = v === cfg.every ? ' selected' : '';
      html += '<option value="' + v + '"' + sel + '>' + v + '</option>';
    });
    html += '</select></div>';

    // Save button
    html += '<div class="control-row" style="border-bottom:none; padding-top:12px;">' +
      '<span></span>' +
      '<div><button class="hb-save" id="hb-save-btn" onclick="saveHeartbeat()">Save Config</button>' +
      '<span class="hb-save-msg" id="hb-save-msg"></span></div>' +
      '</div>';

    html += '</div>';
    body.innerHTML = html;
    addLog('Heartbeat: ' + (data.server_healthy ? 'healthy' : 'down') +
           ', model=' + (data.model || 'none') +
           ', enabled=' + (cfg.enabled ? 'yes' : 'no'));
  }

  /**
   * Save heartbeat config to openclaw.json via POST /api/heartbeat.
   * Reads values from the form controls in the heartbeat card.
   * Shows success/error message and notes that gateway restart is needed.
   */
  window.saveHeartbeat = function() {
    var btn = document.getElementById('hb-save-btn');
    var msg = document.getElementById('hb-save-msg');
    var enabled = document.getElementById('hb-enabled').checked;
    var model = document.getElementById('hb-model').value;
    var every = document.getElementById('hb-every').value;

    btn.disabled = true;
    msg.className = 'hb-save-msg';
    msg.textContent = 'Saving...';

    fetch('/api/heartbeat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: enabled, model: model, every: every }),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      btn.disabled = false;
      if (data.success) {
        msg.className = 'hb-save-msg success';
        msg.textContent = 'Saved! Restart gateway to apply.';
        addLog('Heartbeat config saved (restart required)');
      } else {
        msg.className = 'hb-save-msg error';
        msg.textContent = 'Error: ' + (data.error || 'Unknown');
        addLog('Heartbeat config save FAILED: ' + (data.error || ''));
      }
      setTimeout(function() { msg.textContent = ''; }, 5000);
    })
    .catch(function(err) {
      btn.disabled = false;
      msg.className = 'hb-save-msg error';
      msg.textContent = 'Network error';
      addLog('Heartbeat save error: ' + err);
    });
  };

  // ----------------------------------------------------------------
  // Polling — fetch /api/overview every POLL_INTERVAL ms
  // ----------------------------------------------------------------

  /**
   * Fetch the combined overview endpoint and render all cards.
   * On error, shows OFFLINE in the overall badge.
   */
  function poll() {
    fetch('/api/overview')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        // Update overall status badge
        $overall.className = 'badge ' + data.overall;
        $overall.textContent = data.overall.toUpperCase();
        $lastUpdate.textContent = data.timestamp || new Date().toISOString();
        $collectTime.textContent = (data.collect_time_ms || '--') + ' ms';

        // Render each card from the overview response
        if (data.gpu)        renderGpu(data.gpu);
        if (data.local_gpu)  renderLocalGpu(data.local_gpu);
        if (data.provider)   renderProvider(data.provider);
        if (data.gateway)    renderGateway(data.gateway);
        if (data.tunnel)     renderTunnel(data.tunnel);
        if (data.multimodal) renderMultimodal(data.multimodal);
        if (data.heartbeat)  renderHeartbeat(data.heartbeat);
      })
      .catch(function(err) {
        $overall.className = 'badge error';
        $overall.textContent = 'OFFLINE';
        addLog('Fetch error: ' + err);
      });
  }

  // Start polling immediately, then repeat on interval
  poll();
  setInterval(poll, POLL_INTERVAL);

})();
</script>

</body>
</html>
